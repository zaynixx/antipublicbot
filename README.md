# AntiPublic Telegram Bot

Высокопроизводительный Telegram-бот для работы с большой базой (до 100+ млн строк).

## Что умеет
- Добавлять строки в базу из обычных сообщений.
- Добавлять строки из `.txt` файлов (10KB–50MB).
- Проверять отдельные строки на наличие в базе.
- Быстро работать на очень больших объемах за счёт:
  - хэширования строк (`blake2b`, 16 байт ключ),
  - key-value хранения в **SQLite (WAL) + индекс по хэшу**,
  - пакетных транзакций и дедупликации.

## Архитектура
- `src/storage.py` — слой хранения SQLite.
- `src/importers.py` — потоковый импорт строк из текста/файла.
- `src/bot.py` — Telegram-бот (`python-telegram-bot` v21+, async).
- `src/config.py` — настройки через env.

## Быстрый старт

```bash
python -m venv .venv
source .venv/bin/activate
pip install -e .
cp .env.example .env
# Впишите BOT_TOKEN
python -m src.bot
```

## Переменные окружения
- `BOT_TOKEN` — токен Telegram-бота (обязательно).
- `LMDB_PATH` — путь к SQLite базе (по умолчанию `./data/antipublic.sqlite3`).
- `IMPORT_BATCH_SIZE` — размер батча вставки (по умолчанию `5000`).
- `MAX_FILE_SIZE_MB` — максимальный размер `.txt` файла (по умолчанию `50`).


## Как залить вашу существующую `.txt` базу

Если база большая, **лучше загружать её локально на сервере**, а не через Telegram:

```bash
python -m src.bootstrap /path/to/base.txt
```

Можно указать несколько файлов и свои параметры:

```bash
python -m src.bootstrap /data/part1.txt /data/part2.txt \
  --db-path ./data/antipublic.sqlite3 \
  --batch-size 10000
```

После импорта запускайте бота как обычно:

```bash
python -m src.bot
```

> Через Telegram остаётся доступна загрузка `.txt` (10KB–50MB), но для первоначальной заливки десятков/сотен миллионов строк используйте `src.bootstrap` — это быстрее и стабильнее.

## Как использовать в Telegram
- `/start` — справка.
- `/stats` — статистика базы.
- `/check <строка>` — проверить наличие строки в базе.
- `/add <строка>` — добавить одну строку.
- Просто текстовое сообщение:
  - 1 строка → проверка,
  - несколько строк → пакетное добавление.
- Отправка `.txt` файла → построчный импорт.

## Производительность и масштаб 100M+
1. **Храним только хэш** нормализованной строки — значительно снижает объём.
2. **Потоковый импорт** без загрузки всего файла в RAM.
3. **Пакетные записи** в SQLite в одной транзакции.
4. Для очень высокой нагрузки можно вынести ingestion в отдельный процесс и шардировать данные по префиксу хэша.

## Ограничения
- В текущей реализации значения не хранят исходный текст (только отпечаток). Это оптимально для задач вида "есть/нет".
- Если нужна защита от коллизий выше текущей, можно увеличить длину ключа (например, 20/32 байт).
